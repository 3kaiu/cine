name: Build and Release FPK

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build backend
        working-directory: ./backend
        run: |
          cargo build --release

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: ./frontend
        run: pnpm run build

      - name: Prepare fpk package
        run: |
          # æ¸…ç†æ—§æ„å»º
          rm -rf app config manifest ICON.PNG ICON_256.PNG cmd

          mkdir -p app/{frontend,backend}
          mkdir -p config
          mkdir -p cmd
          
          # å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶
          cp backend/target/release/cine-backend app/backend/
          
          # å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
          cp -r frontend/dist/* app/frontend/
          
          # å¤„ç†å›¾æ ‡ (ä½¿ç”¨ GitHub Actions ç¯å¢ƒä¸­çš„ convert æˆ–ç›´æ¥å¤åˆ¶)
          if [ -f "frontend/public/icon.svg" ]; then
             cp frontend/public/icon.svg ICON.PNG
             cp frontend/public/icon.svg ICON_256.PNG
          else
             touch ICON.PNG ICON_256.PNG
          fi
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶ (config/privilege åœ¨æ ¹ç›®å½•)
          cat > config/privilege <<EOF
          {
              "defaults": {
                  "run-as": "root"
              },
              "filesystem": {
                  "read": ["/"],
                  "write": ["/data/cine"]
              }
          }
          EOF
          
          # åº”ç”¨å†…é…ç½®
          mkdir -p app/config
          cat > app/config/config.json <<EOF
          {
              "port": 3000,
              "database_url": "sqlite:/data/cine.db",
              "hash_cache_dir": "/data/cine/hash_cache",
              "trash_dir": "/data/cine/trash"
          }
          EOF
          
          # è¯»å–ç‰ˆæœ¬å·
          VERSION=$(grep -m1 '^version' backend/Cargo.toml | cut -d'"' -f2)
          
          # åˆ›å»º manifest (æ³¨æ„ï¼šæ–‡ä»¶åä¸º manifest)
          cat > manifest <<EOF
          {
              "app": "cine",
              "version": "$VERSION",
              "description": "Cine - ä¸“ä¸ºNASç”¨æˆ·æ‰“é€ çš„é«˜æ€§èƒ½å½±è§†æ–‡ä»¶ç®¡ç†å·¥å…·",
              "main": "app/backend/cine-backend",
              "author": "Cine Team",
              "license": "MIT"
          }
          EOF

      - name: Get version for package
        id: package_version
        run: |
          VERSION=$(grep -m1 '^version' backend/Cargo.toml | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install fnpack
        run: |
          # é£ç‰›OS å®˜æ–¹ fnpack å·¥å…·ä¸‹è½½åœ°å€
          FNPACK_URL="https://static2.fnnas.com/fnpack/fnpack-1.2.0-linux-amd64"
          echo "ä» $FNPACK_URL ä¸‹è½½ fnpack..."
          
          if curl -L -o /tmp/fnpack "$FNPACK_URL"; then
            chmod +x /tmp/fnpack
            sudo mv /tmp/fnpack /usr/local/bin/fnpack
            if fnpack --version || true; then
              echo "âœ… fnpack å®‰è£…æˆåŠŸ"
              echo "FPK_BUILD=true" >> $GITHUB_ENV
            else
              echo "âš ï¸ fnpack è¿è¡Œå¤±è´¥ï¼Œå›é€€åˆ° tar.gz"
              echo "FPK_BUILD=false" >> $GITHUB_ENV
            fi
          else
            echo "âŒ fnpack ä¸‹è½½å¤±è´¥ï¼Œå°†åˆ›å»º tar.gz åŒ…"
            echo "FPK_BUILD=false" >> $GITHUB_ENV
          fi

      - name: Build FPK file
        id: build_fpk
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          
          if [ "${{ env.FPK_BUILD }}" = "true" ]; then
            echo "ä½¿ç”¨ fnpack æ„å»º fpk æ–‡ä»¶..."
            fnpack build
            if [ -f "cine.fpk" ]; then
              mv cine.fpk cine-$VERSION.fpk
              echo "FPK_FILE=cine-$VERSION.fpk" >> $GITHUB_ENV
              echo "FPK_EXTENSION=fpk" >> $GITHUB_ENV
            else
              echo "fpk æ–‡ä»¶ç”Ÿæˆå¤±è´¥ï¼Œå›é€€åˆ° tar.gz"
              echo "FPK_BUILD=false" >> $GITHUB_ENV
            fi
          fi
          
          if [ "${{ env.FPK_BUILD }}" != "true" ]; then
            echo "åˆ›å»º tar.gz å‹ç¼©åŒ…..."
            # æ‰“åŒ…æ‰€æœ‰å¿…è¦æ–‡ä»¶ï¼šapp, config, manifest, command, icons
            tar -czf cine-$VERSION.tar.gz app/ config/ cmd/ manifest ICON.PNG ICON_256.PNG
            echo "FPK_FILE=cine-$VERSION.tar.gz" >> $GITHUB_ENV
            echo "FPK_EXTENSION=tar.gz" >> $GITHUB_ENV
          fi
          
          # åˆ›å»ºå®‰è£…è¯´æ˜
          cat > INSTALL.md <<EOF
          # Cine å®‰è£…è¯´æ˜
          
          ## æ–¹å¼ä¸€ï¼šç›´æ¥å®‰è£… fpk æ–‡ä»¶ï¼ˆæ¨èï¼‰
          
          1. ä¸‹è½½ \`cine-$VERSION.fpk\` æ–‡ä»¶
          2. åœ¨é£ç‰›OSç®¡ç†ç•Œé¢ä¸­ä¸Šä¼ å¹¶å®‰è£…
          
          ## æ–¹å¼äºŒï¼šä½¿ç”¨ tar.gz åŒ…
          
          1. ä¸‹è½½å¹¶è§£å‹ \`cine-$VERSION.tar.gz\`
          2. åœ¨è§£å‹åçš„ç›®å½•ä¸­è¿è¡Œ \`fnpack build\` ç”Ÿæˆ fpk æ–‡ä»¶
          3. åœ¨é£ç‰›OSç®¡ç†ç•Œé¢ä¸­ä¸Šä¼ å¹¶å®‰è£…ç”Ÿæˆçš„ fpk æ–‡ä»¶
          
          ## æ–‡ä»¶ç»“æ„
          
          \`\`\`
          app/
          â”œâ”€â”€ backend/
          â”‚   â””â”€â”€ cine-backend  # åç«¯å¯æ‰§è¡Œæ–‡ä»¶
          â”œâ”€â”€ frontend/            # å‰ç«¯é™æ€æ–‡ä»¶
          â””â”€â”€ config/              # é…ç½®æ–‡ä»¶
          \`\`\`
          EOF

      - name: Get version and tag
        id: get_version
        run: |
          VERSION=$(grep -m1 '^version' backend/Cargo.toml | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # ä» tag æˆ– ref ä¸­æå–ç‰ˆæœ¬å·
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
          else
            TAG_NAME="v$VERSION"
          fi
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Tag: $TAG_NAME"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## Cine ${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¦ ä¸‹è½½å®‰è£…åŒ…
            
            - **FPK æ–‡ä»¶**: `cine-${{ steps.get_version.outputs.version }}.fpk` - å¯ç›´æ¥å®‰è£…çš„ fpk æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            - **FPK åŒ…**: `cine-${{ steps.get_version.outputs.version }}.tar.gz` - åŒ…å«å®Œæ•´åº”ç”¨æ–‡ä»¶çš„å‹ç¼©åŒ…
            - **åç«¯äºŒè¿›åˆ¶**: `cine-backend-${{ steps.get_version.outputs.version }}-linux-x86_64` - ä»…åç«¯å¯æ‰§è¡Œæ–‡ä»¶
            - **å®‰è£…è¯´æ˜**: `INSTALL.md` - è¯¦ç»†çš„å®‰è£…æŒ‡å—
            
            ### ğŸš€ å¿«é€Ÿå®‰è£…
            
            1. ä¸‹è½½ `cine-${{ steps.get_version.outputs.version }}.fpk` æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            2. åœ¨é£ç‰›OSç®¡ç†ç•Œé¢ä¸­ä¸Šä¼ å¹¶å®‰è£…
            
            å¦‚æœæ²¡æœ‰ fpk æ–‡ä»¶ï¼Œè¯·ä¸‹è½½ tar.gz åŒ…ï¼Œè§£å‹åè¿è¡Œ \`fnpack build\` ç”Ÿæˆ fpk æ–‡ä»¶ã€‚
            
            ### ğŸ“ å˜æ›´å†…å®¹
            
            æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´ã€‚
          files: |
            ${{ env.FPK_FILE }}
            INSTALL.md
            app/backend/cine-backend
          draft: false
          prerelease: false
