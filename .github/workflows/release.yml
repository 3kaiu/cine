name: Build and Release FPK

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥ v å¼€å¤´çš„ tag æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            backend/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('backend/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build backend
        working-directory: ./backend
        run: |
          cargo build --release

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./frontend
        run: npm run build

      - name: Prepare fpk package
        run: |
          mkdir -p app/{frontend,backend,config}
          
          # å¤åˆ¶åç«¯å¯æ‰§è¡Œæ–‡ä»¶
          cp backend/target/release/cine-backend app/backend/
          
          # å¤åˆ¶å‰ç«¯æ„å»ºäº§ç‰©
          cp -r frontend/dist/* app/frontend/
          
          # åˆ›å»ºé…ç½®æ–‡ä»¶
          cat > app/config/privilege <<EOF
          {
              "defaults": {
                  "run-as": "root"
              },
              "filesystem": {
                  "read": ["/"],
                  "write": ["/data/cine"]
              }
          }
          EOF
          
          cat > app/config/config.json <<EOF
          {
              "port": 3000,
              "database_url": "sqlite:/data/cine.db",
              "hash_cache_dir": "/data/cine/hash_cache",
              "trash_dir": "/data/cine/trash"
          }
          EOF
          
          # è¯»å–ç‰ˆæœ¬å·
          VERSION=$(grep -m1 '^version' backend/Cargo.toml | cut -d'"' -f2)
          
          # åˆ›å»º fnpack.json
          cat > fnpack.json <<EOF
          {
              "name": "cine",
              "version": "$VERSION",
              "description": "Cine - ä¸“ä¸ºNASç”¨æˆ·æ‰“é€ çš„é«˜æ€§èƒ½å½±è§†æ–‡ä»¶ç®¡ç†å·¥å…·",
              "main": "app/backend/cine-backend",
              "author": "Cine Team",
              "license": "MIT"
          }
          EOF

      - name: Get version for package
        id: package_version
        run: |
          VERSION=$(grep -m1 '^version' backend/Cargo.toml | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install fnpack
        run: |
          # å°è¯•å®‰è£… fnpack å·¥å…·
          # æ³¨æ„ï¼šfnpack å¯èƒ½éœ€è¦ä»é£ç‰›OSå®˜æ–¹æºè·å–
          # å¦‚æœä»¥ä¸‹æ–¹æ³•éƒ½å¤±è´¥ï¼Œå°†å›é€€åˆ°åˆ›å»º tar.gz åŒ…
          
          FPK_AVAILABLE=false
          
          # æ–¹æ³•1: æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
          if command -v fnpack &> /dev/null; then
            echo "fnpack å·²å®‰è£…"
            fnpack --version || true
            FPK_AVAILABLE=true
          fi
          
          # æ–¹æ³•2: å°è¯•ä» npm å®‰è£…ï¼ˆå¦‚æœå‘å¸ƒåˆ° npmï¼‰
          if [ "$FPK_AVAILABLE" = "false" ] && command -v npm &> /dev/null; then
            echo "å°è¯•ä» npm å®‰è£… fnpack..."
            npm install -g @fnos/fnpack 2>/dev/null && FPK_AVAILABLE=true || echo "npm å®‰è£…å¤±è´¥"
          fi
          
          # æ–¹æ³•3: å°è¯•ä¸‹è½½é¢„ç¼–è¯‘äºŒè¿›åˆ¶ï¼ˆéœ€è¦é…ç½®å®é™…ä¸‹è½½åœ°å€ï¼‰
          if [ "$FPK_AVAILABLE" = "false" ]; then
            echo "å°è¯•ä¸‹è½½ fnpack äºŒè¿›åˆ¶..."
            # å–æ¶ˆæ³¨é‡Šå¹¶é…ç½®å®é™…çš„ä¸‹è½½åœ°å€
            # FNPACK_URL="https://github.com/fnos/fnpack/releases/latest/download/fnpack-linux-amd64"
            # curl -L -o /tmp/fnpack "$FNPACK_URL" && chmod +x /tmp/fnpack && sudo mv /tmp/fnpack /usr/local/bin/fnpack && FPK_AVAILABLE=true || echo "äºŒè¿›åˆ¶ä¸‹è½½å¤±è´¥"
            echo "æç¤º: å¦‚éœ€è‡ªåŠ¨ç”Ÿæˆ fpkï¼Œè¯·é…ç½® fnpack ä¸‹è½½åœ°å€æˆ–ä½¿ç”¨ Docker é•œåƒ"
          fi
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          if [ "$FPK_AVAILABLE" = "true" ] && command -v fnpack &> /dev/null; then
            echo "âœ… fnpack å¯ç”¨"
            echo "FPK_BUILD=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ fnpack ä¸å¯ç”¨ï¼Œå°†åˆ›å»º tar.gz åŒ…ï¼ˆç”¨æˆ·å¯æ‰‹åŠ¨ä½¿ç”¨ fnpack ç”Ÿæˆ fpkï¼‰"
            echo "FPK_BUILD=false" >> $GITHUB_ENV
          fi

      - name: Build FPK file
        id: build_fpk
        run: |
          VERSION="${{ steps.package_version.outputs.version }}"
          
          if [ "${{ env.FPK_BUILD }}" = "true" ]; then
            echo "ä½¿ç”¨ fnpack æ„å»º fpk æ–‡ä»¶..."
            fnpack build
            if [ -f "cine.fpk" ]; then
              mv cine.fpk cine-$VERSION.fpk
              echo "FPK_FILE=cine-$VERSION.fpk" >> $GITHUB_ENV
              echo "FPK_EXTENSION=fpk" >> $GITHUB_ENV
            else
              echo "fpk æ–‡ä»¶ç”Ÿæˆå¤±è´¥ï¼Œå›é€€åˆ° tar.gz"
              echo "FPK_BUILD=false" >> $GITHUB_ENV
            fi
          fi
          
          if [ "${{ env.FPK_BUILD }}" != "true" ]; then
            echo "åˆ›å»º tar.gz å‹ç¼©åŒ…..."
            tar -czf cine-$VERSION.tar.gz app/ fnpack.json
            echo "FPK_FILE=cine-$VERSION.tar.gz" >> $GITHUB_ENV
            echo "FPK_EXTENSION=tar.gz" >> $GITHUB_ENV
          fi
          
          # åˆ›å»ºå®‰è£…è¯´æ˜
          cat > INSTALL.md <<EOF
          # Cine å®‰è£…è¯´æ˜
          
          ## æ–¹å¼ä¸€ï¼šç›´æ¥å®‰è£… fpk æ–‡ä»¶ï¼ˆæ¨èï¼‰
          
          1. ä¸‹è½½ \`cine-$VERSION.fpk\` æ–‡ä»¶
          2. åœ¨é£ç‰›OSç®¡ç†ç•Œé¢ä¸­ä¸Šä¼ å¹¶å®‰è£…
          
          ## æ–¹å¼äºŒï¼šä½¿ç”¨ tar.gz åŒ…
          
          1. ä¸‹è½½å¹¶è§£å‹ \`cine-$VERSION.tar.gz\`
          2. åœ¨è§£å‹åçš„ç›®å½•ä¸­è¿è¡Œ \`fnpack build\` ç”Ÿæˆ fpk æ–‡ä»¶
          3. åœ¨é£ç‰›OSç®¡ç†ç•Œé¢ä¸­ä¸Šä¼ å¹¶å®‰è£…ç”Ÿæˆçš„ fpk æ–‡ä»¶
          
          ## æ–‡ä»¶ç»“æ„
          
          \`\`\`
          app/
          â”œâ”€â”€ backend/
          â”‚   â””â”€â”€ cine-backend  # åç«¯å¯æ‰§è¡Œæ–‡ä»¶
          â”œâ”€â”€ frontend/            # å‰ç«¯é™æ€æ–‡ä»¶
          â””â”€â”€ config/              # é…ç½®æ–‡ä»¶
          \`\`\`
          EOF

      - name: Get version and tag
        id: get_version
        run: |
          VERSION=$(grep -m1 '^version' backend/Cargo.toml | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # ä» tag æˆ– ref ä¸­æå–ç‰ˆæœ¬å·
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
          else
            TAG_NAME="v$VERSION"
          fi
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Tag: $TAG_NAME"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## Cine ${{ steps.get_version.outputs.version }}
            
            ### ğŸ“¦ ä¸‹è½½å®‰è£…åŒ…
            
            - **FPK æ–‡ä»¶**: `cine-${{ steps.get_version.outputs.version }}.fpk` - å¯ç›´æ¥å®‰è£…çš„ fpk æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            - **FPK åŒ…**: `cine-${{ steps.get_version.outputs.version }}.tar.gz` - åŒ…å«å®Œæ•´åº”ç”¨æ–‡ä»¶çš„å‹ç¼©åŒ…
            - **åç«¯äºŒè¿›åˆ¶**: `cine-backend-${{ steps.get_version.outputs.version }}-linux-x86_64` - ä»…åç«¯å¯æ‰§è¡Œæ–‡ä»¶
            - **å®‰è£…è¯´æ˜**: `INSTALL.md` - è¯¦ç»†çš„å®‰è£…æŒ‡å—
            
            ### ğŸš€ å¿«é€Ÿå®‰è£…
            
            1. ä¸‹è½½ `cine-${{ steps.get_version.outputs.version }}.fpk` æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            2. åœ¨é£ç‰›OSç®¡ç†ç•Œé¢ä¸­ä¸Šä¼ å¹¶å®‰è£…
            
            å¦‚æœæ²¡æœ‰ fpk æ–‡ä»¶ï¼Œè¯·ä¸‹è½½ tar.gz åŒ…ï¼Œè§£å‹åè¿è¡Œ \`fnpack build\` ç”Ÿæˆ fpk æ–‡ä»¶ã€‚
            
            ### ğŸ“ å˜æ›´å†…å®¹
            
            æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) äº†è§£è¯¦ç»†å˜æ›´ã€‚
          files: |
            ${{ env.FPK_FILE }}
            INSTALL.md
            app/backend/cine-backend
          draft: false
          prerelease: false
